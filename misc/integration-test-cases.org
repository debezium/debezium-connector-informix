#+title: Integration Test Cases

* Integration tests

** Single Connection

*** restartNormal()

|----+-----------------+-----------------------+-----------------------------------------------------------|
| ts | Connector       | conn                  | Testcase Expection                                        |
|----+-----------------+-----------------------+-----------------------------------------------------------|
|  0 |                 | create connection     |                                                           |
|  1 | start-connector |                       |                                                           |
|----+-----------------+-----------------------+-----------------------------------------------------------|
|  2 |                 | begin                 |                                                           |
|  3 |                 | insert (0, 'hello-0') |                                                           |
|  4 |                 | commit                |                                                           |
|----+-----------------+-----------------------+-----------------------------------------------------------|
|  5 |                 |                       | sourceRecords.size = 1                                    |
|  6 |                 |                       | sourceRecords['after'] = (0, 'hello-0')                   |
|  7 | stop-connector  |                       |                                                           |
|----+-----------------+-----------------------+-----------------------------------------------------------|
|    |                 | begin                 |                                                           |
|    |                 | insert (1, 'hello-1') |                                                           |
|    |                 | commit                |                                                           |
|----+-----------------+-----------------------+-----------------------------------------------------------|
|    | start-connector |                       |                                                           |
|----+-----------------+-----------------------+-----------------------------------------------------------|
|    |                 | begin                 |                                                           |
|    |                 | insert (2, 'hello-2') |                                                           |
|    |                 | commit                |                                                           |
|----+-----------------+-----------------------+-----------------------------------------------------------|
|    |                 |                       | sourceRecords.size = 2                                    |
|    |                 |                       | sourceRecords['after'] = [(1, 'hello-1'), (2, 'hello-2')] |
|----+-----------------+-----------------------+-----------------------------------------------------------|
|    | stop-connector  |                       |                                                           |
|----+-----------------+-----------------------+-----------------------------------------------------------|

** Multiple Connections

|----+-----------------+-----------------------+-----------------------+-----------------------------------------|
| ts | Connector       | conn-1                | conn-2                | Testcase Expection                      |
|----+-----------------+-----------------------+-----------------------+-----------------------------------------|
|  0 |                 | create connection     | create connection     |                                         |
|  1 | start-connector |                       |                       |                                         |
|  2 |                 | begin                 |                       |                                         |
|  3 |                 | insert (0, 'hello-0') |                       |                                         |
|  4 |                 | commit                |                       |                                         |
|  5 |                 |                       |                       | sourceRecords.size == 1                 |
|  6 |                 |                       |                       | sourceRecords['after'] = (0, 'hello-0') |
|  7 | stop-connector  |                       |                       |                                         |
|----+-----------------+-----------------------+-----------------------+-----------------------------------------|
|  8 |                 |                       | begin                 |                                         |
|  9 |                 |                       | insert (1, 'hello-1') |                                         |
| 10 |                 |                       | commit                |                                         |
|----+-----------------+-----------------------+-----------------------+-----------------------------------------|
| 11 | start-connector |                       |                       |                                         |
| 12 |                 |                       |                       | sourceRecords.size = 1                  |
| 13 |                 |                       |                       | sourceRecords['after'] = (1, 'hello-1') |
| 14 | stop-connector  |                       |                       |                                         |
|----+-----------------+-----------------------+-----------------------+-----------------------------------------|

** Multiple Connection Interleaved Transaction

|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
| ts | Connector       | conn-1                  | conn-2                  | Testcase Expection                        |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|  0 |                 | create connection       | create connection       |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|  1 | start-connector |                         |                         |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|  2 |                 | begin                   |                         |                                           |                  |
|  3 |                 | insert (0, 'hello-1-0') |                         |                                           |                  |
|  4 |                 | commit                  |                         |                                           | sequenceId == 4  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|  5 |                 |                         |                         | sourceRecords.size = 1                    |                  |
|  6 |                 |                         |                         | sourceRecords['after'] = (0, 'hello-1-0') |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|  7 |                 | begin                   |                         |                                           |                  |
|  8 |                 | insert (1, 'hello-1-1') |                         |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|  9 |                 |                         | begin                   |                                           |                  |
| 10 |                 |                         | insert (0, 'hello-2-0') |                                           |                  |
| 11 |                 |                         | commit                  |                                           | sequenceId == 11 |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
| 12 |                 |                         |                         | sourceRecords.size = 1                    |                  |
| 13 |                 |                         |                         | sourceRecords['after'] = (0, 'hello-2-0') |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|    |                 | insert (2, 'hello-1-2') |                         |                                           |                  |
|    |                 | insert (3, 'hello-1-3') |                         |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|    | stop-connector  |                         |                         |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|    |                 | insert (4, 'hello-1-4') |                         |                                           |                  |
|    |                 | commit                  |                         |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|    | start-connector |                         |                         |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|    |                 |                         | begin                   |                                           |                  |
|    |                 |                         | insert (1, 'hello-2-1') |                                           |                  |
|    |                 |                         | commit                  |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|    |                 |                         |                         | sourceRecords.size = 1                    |                  |
|    |                 |                         |                         | sourceRecords['after'] = (1, 'hello-1-1') |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|
|    | stop-connector  |                         |                         |                                           |                  |
|----+-----------------+-------------------------+-------------------------+-------------------------------------------+------------------|


#+begin_src java
public class InformixStreamingSourceEvent {


    public void execute() {
        InformixTransactionCache transCache = new TransactionCache();

        setCdcEngineSequenceId(commitLsn);

        // Recover Stage
        for (record.cdcStream.getRecord() && record.seqId < changeLsn) {
            switch() {
                transCache.put(record);
            }
        }

        // Main loop
        while(record = cdcStream.getRecord()) {
            switch(record.getType()) {
                case TIMEOUT:
                case BEFORE_UPDATE:
                case AFTER_UPDATE:
                case BEGIN:
                    transCache.put(tranId, {})
                case INSERT:
                    transCache.put(transId, reord);
                case COMMIT:
                    cachedRecord = transCache.clear(transId);
                    disptchEvent(cachedRecord); /// <---
                case ROLLBACK:
                default:
            }
        }
    }
}
#+end_src
